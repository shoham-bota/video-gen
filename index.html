<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Studio</title>
<style>
  :root { --bg: #0f0f0f; --card: #1a1a2e; --border: #2a2a4a; --accent: #7c3aed; --accent-hover: #6d28d9; --text: #e2e8f0; --muted: #94a3b8; --success: #22c55e; --error: #ef4444; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  nav { background: var(--card); border-bottom: 1px solid var(--border); padding: 0 20px; display: flex; align-items: center; gap: 0; }
  nav .logo { font-weight: 700; font-size: 1.1rem; padding: 14px 20px 14px 0; border-right: 1px solid var(--border); margin-right: 0; background: linear-gradient(135deg, #7c3aed, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  nav a { color: var(--muted); text-decoration: none; padding: 14px 20px; font-size: 0.9rem; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
  nav a:hover { color: var(--text); }
  nav a.active { color: var(--text); border-bottom-color: var(--accent); }
  .page { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }
  .page.active { display: block; }
  h1 { font-size: 1.5rem; margin-bottom: 6px; }
  .subtitle { color: var(--muted); margin-bottom: 20px; font-size: 0.85rem; }
  .config-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: end; }
  .field { display: flex; flex-direction: column; gap: 4px; }
  .field label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
  select, input[type="text"], input[type="password"], input[type="number"], textarea { background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 8px 12px; font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
  select:focus, input:focus, textarea:focus { border-color: var(--accent); }
  .row { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: grid; gap: 12px; align-items: start; transition: border-color 0.3s; }
  .video-row { grid-template-columns: 50px 1fr 1fr 1fr auto; }
  .img-row { grid-template-columns: 50px 1fr 2fr auto; }
  .row.generating { border-color: var(--accent); }
  .row.done { border-color: var(--success); }
  .row.error { border-color: var(--error); }
  .row-num { font-size: 1.4rem; font-weight: 700; color: var(--muted); display: flex; align-items: center; justify-content: center; }
  .frame-box { display: flex; flex-direction: column; gap: 4px; }
  .frame-box label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }
  .drop-zone { width: 100%; aspect-ratio: 16/9; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; transition: border-color 0.2s; background-size: cover; background-position: center; }
  .drop-zone:hover { border-color: var(--accent); }
  .drop-zone.optional { border-style: dotted; opacity: 0.7; }
  .drop-zone.optional:hover { opacity: 1; }
  .drop-zone span { color: var(--muted); font-size: 0.7rem; text-align: center; padding: 4px; }
  .drop-zone.has-image span { display: none; }
  .drop-zone input { display: none; }
  .prompt-settings { display: flex; flex-direction: column; gap: 8px; }
  .prompt-settings textarea { resize: vertical; min-height: 55px; font-family: inherit; font-size: 0.85rem; }
  .settings-row { display: flex; gap: 8px; }
  .settings-row select { flex: 1; font-size: 0.8rem; padding: 6px 8px; }
  .actions { display: flex; flex-direction: column; gap: 6px; align-items: center; justify-content: center; min-width: 100px; }
  .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-success { background: var(--success); color: white; }
  .btn-small { padding: 6px 12px; font-size: 0.75rem; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-outline:hover { border-color: var(--accent); }
  .status { font-size: 0.7rem; color: var(--muted); text-align: center; min-height: 16px; max-width: 120px; word-break: break-word; }
  .status.error { color: var(--error); }
  .status.success { color: var(--success); }
  .result-area { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
  .bottom-bar { display: flex; gap: 12px; justify-content: center; margin-top: 20px; padding: 16px; }
  .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .output-img { max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; }
  .info-box { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; font-size: 0.8rem; color: var(--muted); line-height: 1.5; }
  .info-box a { color: var(--accent); }
  .multi-img-zone { display: flex; flex-wrap: wrap; gap: 8px; }
  .multi-img-zone .img-thumb { width: 80px; height: 80px; border-radius: 8px; border: 1px solid var(--border); position: relative; background-size: cover; background-position: center; }
  .multi-img-zone .img-thumb .remove-img { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: var(--error); color: white; border: none; border-radius: 50%; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
  .multi-img-zone .add-img-btn { width: 80px; height: 80px; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--muted); font-size: 1.5rem; transition: border-color 0.2s; background: transparent; }
  .multi-img-zone .add-img-btn:hover { border-color: var(--accent); color: var(--accent); }
  .multi-img-zone.drag-over .add-img-btn { border-color: var(--accent); color: var(--accent); }
  .img-zone-hint { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
  .img-zone-hidden { display: none; }
  .nano-settings-row, .video-settings-row { display: flex; gap: 6px; flex-wrap: wrap; }
  .nano-settings-row select, .video-settings-row select { font-size: 0.8rem; padding: 6px 8px; }
  .video-settings-row label.cb-label { font-size: 0.75rem; color: var(--muted); display: flex; align-items: center; gap: 4px; cursor: pointer; }
  .video-settings-row input[type="checkbox"] { accent-color: var(--accent); }
  .output-video { max-width: 280px; max-height: 200px; border-radius: 8px; border: 1px solid var(--border); }
  @media (max-width: 900px) { .video-row, .img-row { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<nav>
  <span class="logo">üé¨ AI Studio</span>
  <a href="#video" class="active" onclick="showPage('video')">Video Gen</a>
  <a href="#nano" onclick="showPage('nano')">Nano Banana</a>
  <a href="#flux" onclick="showPage('flux')">Flux LoRA</a>
</nav>

<!-- VIDEO PAGE -->
<div class="page active" id="page-video">
  <h1>üé¨ Video Generation</h1>
  <p class="subtitle">Start frame ‚Üí End frame transitions via fal.ai (Kling)</p>
  <div class="config-bar">
    <div class="field"><label>fal.ai API Key</label><input type="password" id="v-apiKey" placeholder="paste your fal key" style="width:300px"></div>
    <div class="field"><label>&nbsp;</label><button class="btn btn-primary" onclick="videoGenerateAll()">üöÄ Generate All</button></div>
  </div>
  <div id="video-rows"></div>
  <div class="bottom-bar">
    <button class="btn btn-primary" onclick="videoGenerateAll()">üöÄ Generate All</button>
    <button class="btn btn-success" onclick="videoDownloadAll()">üì¶ Download All</button>
  </div>
</div>

<!-- NANO BANANA PAGE -->
<div class="page" id="page-nano">
  <h1>üçå Nano Banana (Gemini ¬∑ Imagen ¬∑ Veo)</h1>
  <p class="subtitle">Generate or edit images & video using Google AI models</p>
  <div class="info-box">
    <strong>Generate:</strong> Just type a prompt. <strong>Edit:</strong> Drop an image + describe the edit.<br>
    üíé = paid model (requires billing-enabled key). Get your key at <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com/apikey</a>
  </div>
  <div class="config-bar">
    <div class="field"><label>Gemini API Key</label><input type="password" id="n-apiKey" placeholder="paste Gemini key" style="width:300px"></div>
    <div class="field"><label>&nbsp;</label><button class="btn btn-primary" onclick="nanoGenerateAll()">üöÄ Generate All</button></div>
  </div>
  <div id="nano-rows"></div>
  <div class="bottom-bar">
    <button class="btn btn-primary" onclick="nanoGenerateAll()">üöÄ Generate All</button>
    <button class="btn btn-success" onclick="nanoDownloadAll()">üì¶ Download All</button>
  </div>
</div>

<!-- FLUX LORA PAGE -->
<div class="page" id="page-flux">
  <h1>üé® Flux LoRA</h1>
  <p class="subtitle">Generate images with custom LoRA models via fal.ai</p>
  <div class="info-box">
    Provide your LoRA weights URL + trigger word. The trigger word must appear in your prompt.<br>
    Train LoRA at <a href="https://fal.ai/models/fal-ai/flux-lora-fast-training" target="_blank">fal.ai flux-lora-fast-training</a>
  </div>
  <div class="config-bar">
    <div class="field"><label>fal.ai API Key</label><input type="password" id="f-apiKey" placeholder="paste fal key" style="width:300px"></div>
    <div class="field"><label>LoRA URL</label><input type="text" id="f-loraUrl" placeholder="https://...safetensors" style="width:280px"></div>
    <div class="field"><label>Trigger</label><input type="text" id="f-trigger" placeholder="MYSUBJECT" style="width:110px"></div>
    <div class="field"><label>Scale</label><input type="number" id="f-scale" value="0.9" min="0" max="1.5" step="0.1" style="width:65px"></div>
    <div class="field"><label>Size</label>
      <select id="f-size">
        <option value="landscape_16_9">16:9</option>
        <option value="portrait_4_3">4:3 Portrait</option>
        <option value="square">Square</option>
        <option value="landscape_4_3">4:3 Landscape</option>
      </select>
    </div>
    <div class="field"><label>&nbsp;</label><button class="btn btn-primary" onclick="fluxGenerateAll()">üöÄ Generate All</button></div>
  </div>
  <div id="flux-rows"></div>
  <div class="bottom-bar">
    <button class="btn btn-primary" onclick="fluxGenerateAll()">üöÄ Generate All</button>
    <button class="btn btn-success" onclick="fluxDownloadAll()">üì¶ Download All</button>
  </div>
</div>

<script>
// NAV
function showPage(p){document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));document.querySelectorAll('nav a').forEach(x=>x.classList.remove('active'));document.getElementById('page-'+p).classList.add('active');document.querySelector('nav a[href="#'+p+'"]').classList.add('active');}
window.addEventListener('hashchange',()=>{const h=location.hash.slice(1);if(['video','nano','flux'].includes(h))showPage(h);});
if(location.hash){const h=location.hash.slice(1);if(['video','nano','flux'].includes(h))showPage(h);}

// UTILS
function setStatus(id,type,text){const el=document.getElementById(id);el.className='status '+type;el.innerHTML=type==='generating'?'<span class="spinner"></span> '+text:text;const row=el.closest('.row');if(row)row.className=row.className.replace(/ (generating|done|error)/g,'')+(type==='generating'?' generating':type==='success'?' done':type==='error'?' error':'');}
function setupDZ(z,cb){z.addEventListener('dragover',e=>{e.preventDefault();z.style.borderColor='var(--accent)';});z.addEventListener('dragleave',()=>z.style.borderColor='');z.addEventListener('drop',e=>{e.preventDefault();z.style.borderColor='';const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))cb(f);});z.addEventListener('click',()=>z.querySelector('input[type=file]')?.click());}
function preview(z,f){const r=new FileReader();r.onload=e=>{z.style.backgroundImage='url('+e.target.result+')';z.classList.add('has-image');};r.readAsDataURL(f);}
function toB64(f){return new Promise(r=>{const x=new FileReader();x.onload=()=>r(x.result.split(',')[1]);x.readAsDataURL(f);})}
async function falUp(f,k){const i=await fetch('https://rest.alpha.fal.ai/storage/upload/initiate',{method:'POST',headers:{'Authorization':'Key '+k,'Content-Type':'application/json'},body:JSON.stringify({file_name:f.name,content_type:f.type})});if(!i.ok)throw new Error('Upload init: '+i.status);const d=await i.json();const u=await fetch(d.upload_url,{method:'PUT',headers:{'Content-Type':f.type},body:f});if(!u.ok)throw new Error('Upload: '+u.status);return d.file_url;}
async function falPoll(model,args,k,sid){const r=await fetch('https://queue.fal.run/'+model,{method:'POST',headers:{'Authorization':'Key '+k,'Content-Type':'application/json'},body:JSON.stringify(args)});if(!r.ok)throw new Error(await r.text());const{request_id}=await r.json();setStatus(sid,'generating','Queued...');while(true){await new Promise(r=>setTimeout(r,5000));const resp=await fetch('https://queue.fal.run/'+model+'/requests/'+request_id,{headers:{'Authorization':'Key '+k}});if(resp.status===200){return await resp.json();}else if(resp.status===202){setStatus(sid,'generating','Processing...');}else{const t=await resp.text();throw new Error('Poll error '+resp.status+': '+t.substring(0,80));}}}

// VIDEO
const VIDEO_MODEL_DEFS=[
  {id:'fal-ai/kling-video/v3/pro/image-to-video',label:'Kling 3.0 Pro',price:'$0.224/s',durations:['3','4','5','6','7','8','9','10','11','12','13','14','15'],ratios:['16:9','9:16','1:1'],audio:true},
  {id:'fal-ai/kling-video/v3/standard/image-to-video',label:'Kling 3.0 Standard',price:'$0.168/s',durations:['3','4','5','6','7','8','9','10','11','12','13','14','15'],ratios:['16:9','9:16','1:1'],audio:true},
  {id:'fal-ai/kling-video/v2.6/pro/image-to-video',label:'Kling 2.6 Pro',price:'$0.07/s',durations:['5','10'],ratios:['16:9','9:16','1:1'],audio:true},
  {id:'fal-ai/kling-video/v2/master/image-to-video',label:'Kling 2.0 Master',price:'$0.035/s',durations:['5','10'],ratios:['16:9','9:16','1:1'],audio:false},
  {id:'fal-ai/kling-video/v1.5/pro/image-to-video',label:'Kling 1.5 Pro',price:'$0.028/s',durations:['5','10'],ratios:['16:9','9:16','1:1'],audio:false},
];
function vModelDef(id){return VIDEO_MODEL_DEFS.find(m=>m.id===id)||VIDEO_MODEL_DEFS[0];}
function vBuildModelOpts(){return VIDEO_MODEL_DEFS.map(m=>'<option value="'+m.id+'">'+m.label+' ('+m.price+')</option>').join('');}

const NV=10,vS=Array.from({length:NV},()=>({sf:null,ef:null,su:null,eu:null,vu:null}));

// Persist start/end frames to localStorage
function vPersistImgs(i){
  const save=(f,key)=>{if(!f)return localStorage.removeItem(key);const r=new FileReader();r.onload=e=>{const d=JSON.stringify({dataUrl:e.target.result,name:f.name,type:f.type});if(d.length>4*1024*1024)return;try{localStorage.setItem(key,d);}catch(e){}};r.readAsDataURL(f);};
  save(vS[i].sf,'vid-sf-'+i);save(vS[i].ef,'vid-ef-'+i);
}
function vRestoreImg(key){
  try{
    const raw=localStorage.getItem(key);if(!raw)return null;
    const item=JSON.parse(raw);
    const byteStr=atob(item.dataUrl.split(',')[1]);
    const ab=new ArrayBuffer(byteStr.length);const ia=new Uint8Array(ab);
    for(let j=0;j<byteStr.length;j++)ia[j]=byteStr.charCodeAt(j);
    return new File([new Blob([ab],{type:item.type})],item.name,{type:item.type});
  }catch(e){return null;}
}

function vUpdateRowSettings(i){
  const sel=document.getElementById('vm-'+i);if(!sel)return;
  const md=vModelDef(sel.value);
  const durSel=document.getElementById('vd-'+i);
  const arSel=document.getElementById('va-'+i);
  const audioWrap=document.getElementById('vaud-wrap-'+i);
  const oldDur=durSel?durSel.value:null;
  const oldAr=arSel?arSel.value:null;
  if(durSel){
    durSel.innerHTML=md.durations.map(d=>'<option value="'+d+'">'+d+'s</option>').join('');
    if(oldDur&&md.durations.includes(oldDur))durSel.value=oldDur;
  }
  if(arSel){
    arSel.innerHTML=md.ratios.map(r=>'<option value="'+r+'">'+r+'</option>').join('');
    if(oldAr&&md.ratios.includes(oldAr))arSel.value=oldAr;
  }
  if(audioWrap){audioWrap.style.display=md.audio?'':'none';}
}

function initV(){
  const c=document.getElementById('video-rows');c.innerHTML='';
  const modelOpts=vBuildModelOpts();
  for(let i=0;i<NV;i++){
    c.innerHTML+='<div class="row video-row" id="vr-'+i+'">'
      +'<div class="row-num">'+(i+1)+'</div>'
      +'<div class="frame-box"><label>Start Frame *</label><div class="drop-zone" id="vs-'+i+'"><span>Drop / click</span><input type="file" accept="image/*"></div></div>'
      +'<div class="frame-box"><label>End Frame (optional)</label><div class="drop-zone optional" id="ve-'+i+'"><span>Optional</span><input type="file" accept="image/*"></div></div>'
      +'<div class="prompt-settings"><textarea id="vp-'+i+'" placeholder="Describe transition..."></textarea>'
      +'<div class="video-settings-row">'
      +'<select id="vm-'+i+'" onchange="vUpdateRowSettings('+i+')">'+modelOpts+'</select>'
      +'<select id="vd-'+i+'" title="Duration"></select>'
      +'<select id="va-'+i+'" title="Aspect ratio"></select>'
      +'<span id="vaud-wrap-'+i+'"><label class="cb-label"><input type="checkbox" id="vau-'+i+'" checked> Audio</label></span>'
      +'</div></div>'
      +'<div class="actions"><button class="btn btn-primary btn-small" onclick="vGen('+i+')">Generate</button>'
      +'<div class="status" id="vst-'+i+'"></div><div class="result-area" id="vres-'+i+'"></div></div></div>';
  }
  for(let i=0;i<NV;i++){
    // Restore persisted images
    const rsf=vRestoreImg('vid-sf-'+i);
    const ref=vRestoreImg('vid-ef-'+i);
    if(rsf){vS[i].sf=rsf;preview(document.getElementById('vs-'+i),rsf);}
    if(ref){vS[i].ef=ref;preview(document.getElementById('ve-'+i),ref);}
    vUpdateRowSettings(i);
    const si=document.getElementById('vs-'+i),ei=document.getElementById('ve-'+i);
    setupDZ(si,f=>{vS[i].sf=f;vS[i].su=null;preview(si,f);vPersistImgs(i);});
    setupDZ(ei,f=>{vS[i].ef=f;vS[i].eu=null;preview(ei,f);vPersistImgs(i);});
    si.querySelector('input').onchange=e=>{const f=e.target.files[0];if(f){vS[i].sf=f;vS[i].su=null;preview(si,f);vPersistImgs(i);}};
    ei.querySelector('input').onchange=e=>{const f=e.target.files[0];if(f){vS[i].ef=f;vS[i].eu=null;preview(ei,f);vPersistImgs(i);}};
  }
}

async function vGen(i){
  const k=document.getElementById('v-apiKey').value.trim();
  if(!k)return setStatus('vst-'+i,'error','Enter API key');
  if(!vS[i].sf)return setStatus('vst-'+i,'error','Add start frame');
  const md=vModelDef(document.getElementById('vm-'+i).value);
  try{
    setStatus('vst-'+i,'generating','Uploading...');
    if(!vS[i].su)vS[i].su=await falUp(vS[i].sf,k);
    if(vS[i].ef&&!vS[i].eu)vS[i].eu=await falUp(vS[i].ef,k);
    setStatus('vst-'+i,'generating','Submitting...');
    const a={
      prompt:document.getElementById('vp-'+i).value||'Smooth cinematic transition',
      start_image_url:vS[i].su,
      duration:document.getElementById('vd-'+i).value,
      aspect_ratio:document.getElementById('va-'+i).value
    };
    if(vS[i].eu)a.end_image_url=vS[i].eu;
    if(md.audio){a.generate_audio=document.getElementById('vau-'+i).checked;}
    const r=await falPoll(md.id,a,k,'vst-'+i);
    vS[i].vu=r.video.url;
    setStatus('vst-'+i,'success','Done!');
    document.getElementById('vres-'+i).innerHTML='<a href="'+r.video.url+'" target="_blank" class="btn btn-outline btn-small">‚ñ∂</a><a href="'+r.video.url+'" download="video_'+(i+1)+'.mp4" class="btn btn-success btn-small">‚¨á</a>';
  }catch(e){setStatus('vst-'+i,'error',e.message.substring(0,60));}
}
function videoGenerateAll(){const p=[];for(let i=0;i<NV;i++)if(vS[i].sf&&!vS[i].vu)p.push(vGen(i));if(!p.length)alert('Add start frame to at least one row');Promise.allSettled(p);}
function videoDownloadAll(){vS.forEach((s,i)=>{if(s.vu){const a=document.createElement('a');a.href=s.vu;a.download='video_'+(i+1)+'.mp4';a.click();}});}

// NANO
const NANO_MODEL_DEFS=[
  {id:'gemini-2.5-flash-image',label:'Gemini 2.5 Flash ¬∑ Nano Banana',type:'gemini',maxImages:10,paid:false,ratios:['1:1','3:2','2:3','4:3','3:4','16:9','9:16'],sizes:['1K']},
  {id:'gemini-3-pro-image-preview',label:'Gemini 3 Pro ¬∑ Nano Banana Pro',type:'gemini',maxImages:14,paid:true,ratios:['1:1','3:2','2:3','4:3','3:4','16:9','9:16'],sizes:['1K','2K','4K']},
  {id:'imagen-4.0-generate-001',label:'Imagen 4',type:'imagen',maxImages:0,paid:true,ratios:['1:1','3:4','4:3','9:16','16:9'],sizes:[]},
  {id:'imagen-4.0-fast-generate-001',label:'Imagen 4 Fast',type:'imagen',maxImages:0,paid:true,ratios:['1:1','3:4','4:3','9:16','16:9'],sizes:[]},
  {id:'imagen-4.0-ultra-generate-001',label:'Imagen 4 Ultra',type:'imagen',maxImages:0,paid:true,ratios:['1:1','3:4','4:3','9:16','16:9'],sizes:[]},
  {id:'veo-3.1-generate-preview',label:'Veo 3.1 ¬∑ video',type:'veo',maxImages:2,paid:true,ratios:['16:9','9:16'],durations:['4','6','8'],resolutions:['720p','1080p','4k']},
];
function nModelDef(id){return NANO_MODEL_DEFS.find(m=>m.id===id)||NANO_MODEL_DEFS[0];}

const NN=10,nS=Array.from({length:NN},()=>({imgs:[],ru:null,rb:null}));

// Persist images to localStorage
function nPersistImgs(i){
  const promises=nS[i].imgs.map(f=>new Promise(res=>{const r=new FileReader();r.onload=e=>res({dataUrl:e.target.result,name:f.name,type:f.type});r.readAsDataURL(f);}));
  Promise.all(promises).then(arr=>{
    const json=JSON.stringify(arr);
    if(json.length>4*1024*1024)return; // skip if >4MB
    try{localStorage.setItem('nano-imgs-'+i,json);}catch(e){}
  });
}
function nRestoreImgs(i){
  try{
    const raw=localStorage.getItem('nano-imgs-'+i);
    if(!raw)return;
    const arr=JSON.parse(raw);
    arr.forEach(item=>{
      const byteStr=atob(item.dataUrl.split(',')[1]);
      const ab=new ArrayBuffer(byteStr.length);
      const ia=new Uint8Array(ab);
      for(let j=0;j<byteStr.length;j++)ia[j]=byteStr.charCodeAt(j);
      const blob=new Blob([ab],{type:item.type});
      const file=new File([blob],item.name,{type:item.type});
      nS[i].imgs.push(file);
    });
  }catch(e){}
}

function nRenderThumbs(i){
  const c=document.getElementById('ni-'+i);if(!c)return;
  c.innerHTML='';
  nS[i].imgs.forEach((f,j)=>{
    const t=document.createElement('div');t.className='img-thumb';
    const r=new FileReader();r.onload=e=>t.style.backgroundImage='url('+e.target.result+')';r.readAsDataURL(f);
    const rm=document.createElement('button');rm.className='remove-img';rm.textContent='√ó';
    rm.onclick=e=>{e.stopPropagation();nS[i].imgs.splice(j,1);nRenderThumbs(i);nPersistImgs(i);};
    t.appendChild(rm);c.appendChild(t);
  });
  const md=nModelDef(document.getElementById('nm-'+i)?.value);
  if(md&&md.maxImages>0&&nS[i].imgs.length<md.maxImages){
    const ab=document.createElement('button');ab.className='add-img-btn';ab.textContent='+';
    ab.onclick=()=>fi.click();
    const fi=document.createElement('input');fi.type='file';fi.accept='image/*';fi.multiple=true;fi.style.display='none';
    fi.onchange=e=>{for(const f of e.target.files)nS[i].imgs.push(f);nRenderThumbs(i);nPersistImgs(i);};
    ab.appendChild(fi);c.appendChild(ab);
  }
}

function nBuildModelOpts(){
  return NANO_MODEL_DEFS.map(m=>'<option value="'+m.id+'">'+(m.paid?'üíé ':'')+m.label+'</option>').join('');
}

function nUpdateRowSettings(i){
  const sel=document.getElementById('nm-'+i);if(!sel)return;
  const md=nModelDef(sel.value);
  // Aspect ratio
  const arSel=document.getElementById('nar-'+i);
  const oldAr=arSel?arSel.value:null;
  // Size
  const szWrap=document.getElementById('nsz-wrap-'+i);
  // Duration
  const durWrap=document.getElementById('ndur-wrap-'+i);
  // Resolution
  const resWrap=document.getElementById('nres-wrap-'+i);
  // Rebuild aspect ratio
  if(arSel){
    arSel.innerHTML=md.ratios.map(r=>'<option value="'+r+'">'+r+'</option>').join('');
    if(oldAr&&md.ratios.includes(oldAr))arSel.value=oldAr;
  }
  // Size dropdown (gemini only)
  if(szWrap){
    if(md.sizes&&md.sizes.length>0){
      szWrap.style.display='';
      const szSel=document.getElementById('nsz-'+i);
      szSel.innerHTML=md.sizes.map(s=>'<option value="'+s+'">'+s+'</option>').join('');
    } else { szWrap.style.display='none'; }
  }
  // Duration (veo only)
  if(durWrap){
    if(md.durations){
      durWrap.style.display='';
      const durSel=document.getElementById('ndur-'+i);
      durSel.innerHTML=md.durations.map(d=>'<option value="'+d+'">'+d+'s</option>').join('');
    } else { durWrap.style.display='none'; }
  }
  // Resolution (veo only)
  if(resWrap){
    if(md.resolutions){
      resWrap.style.display='';
      const resSel=document.getElementById('nreso-'+i);
      resSel.innerHTML=md.resolutions.map(r=>'<option value="'+r+'">'+r+'</option>').join('');
    } else { resWrap.style.display='none'; }
  }
  // Image zone visibility + hint
  const imgBox=document.getElementById('nimgbox-'+i);
  const imgHint=document.getElementById('nimghint-'+i);
  if(imgBox){
    if(md.maxImages===0){
      imgBox.classList.add('img-zone-hidden');
    } else {
      imgBox.classList.remove('img-zone-hidden');
      if(imgHint){
        if(md.type==='veo') imgHint.textContent='1st = start frame, 2nd = end frame';
        else imgHint.textContent='';
      }
    }
  }
  nRenderThumbs(i);
}

function initN(){
  const c=document.getElementById('nano-rows');c.innerHTML='';
  const modelOpts=nBuildModelOpts();
  for(let i=0;i<NN;i++){
    c.innerHTML+='<div class="row img-row" id="nr-'+i+'">'
      +'<div class="row-num">'+(i+1)+'</div>'
      +'<div class="frame-box" id="nimgbox-'+i+'"><label>Images (optional)</label>'
      +'<div class="multi-img-zone" id="ni-'+i+'"></div>'
      +'<div class="img-zone-hint" id="nimghint-'+i+'"></div></div>'
      +'<div class="prompt-settings"><textarea id="np-'+i+'" placeholder="Describe what to generate or edit..."></textarea>'
      +'<div class="nano-settings-row">'
      +'<select id="nm-'+i+'" onchange="nUpdateRowSettings('+i+')">'+modelOpts+'</select>'
      +'<select id="nar-'+i+'" title="Aspect ratio"></select>'
      +'<span id="nsz-wrap-'+i+'" style="display:none"><select id="nsz-'+i+'" title="Size"></select></span>'
      +'<span id="ndur-wrap-'+i+'" style="display:none"><select id="ndur-'+i+'" title="Duration"></select></span>'
      +'<span id="nres-wrap-'+i+'" style="display:none"><select id="nreso-'+i+'" title="Resolution"></select></span>'
      +'</div></div>'
      +'<div class="actions"><button class="btn btn-primary btn-small" onclick="nGen('+i+')">Generate</button>'
      +'<div class="status" id="nst-'+i+'"></div><div class="result-area" id="nres-'+i+'"></div></div></div>';
  }
  for(let i=0;i<NN;i++){
    nRestoreImgs(i);
    nUpdateRowSettings(i);
    const zone=document.getElementById('ni-'+i);
    zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over');});
    zone.addEventListener('dragleave',()=>zone.classList.remove('drag-over'));
    zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag-over');
      for(const f of e.dataTransfer.files){if(f.type.startsWith('image/'))nS[i].imgs.push(f);}
      nRenderThumbs(i);nPersistImgs(i);
    });
  }
}

async function nGenGemini(i,k,pr,md){
  setStatus('nst-'+i,'generating','Generating...');
  const parts=[{text:pr}];
  for(const f of nS[i].imgs){const b=await toB64(f);parts.push({inlineData:{mimeType:f.type,data:b}});}
  const ar=document.getElementById('nar-'+i).value;
  const genCfg={responseModalities:['TEXT','IMAGE'],imageConfig:{aspectRatio:ar}};
  const szSel=document.getElementById('nsz-'+i);
  if(szSel&&md.sizes.length>0)genCfg.imageConfig.imageSize=szSel.value;
  const resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+md.id+':generateContent?key='+k,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({contents:[{parts}],generationConfig:genCfg})
  });
  if(!resp.ok){const et=await resp.text();throw new Error('API '+resp.status+': '+et.substring(0,100));}
  const d=await resp.json();
  if(!d.candidates||!d.candidates[0])throw new Error('No candidates returned');
  const allParts=d.candidates[0].content?.parts||[];
  const ip=allParts.find(p=>p.inlineData||p.inline_data);
  if(!ip){const tp=allParts.find(p=>p.text);throw new Error(tp?'Text only: "'+tp.text.substring(0,80)+'"':'No image returned');}
  const idata=ip.inlineData||ip.inline_data;
  const bl=new Blob([Uint8Array.from(atob(idata.data),c=>c.charCodeAt(0))],{type:idata.mimeType||idata.mime_type});
  const u=URL.createObjectURL(bl);
  nS[i].ru=u;nS[i].rb=bl;
  setStatus('nst-'+i,'success','Done!');
  document.getElementById('nres-'+i).innerHTML='<img src="'+u+'" class="output-img" onclick="window.open(this.src)"><a href="'+u+'" download="nano_'+(i+1)+'.png" class="btn btn-success btn-small">‚¨á</a>';
}

async function nGenImagen(i,k,pr,md){
  setStatus('nst-'+i,'generating','Generating...');
  const ar=document.getElementById('nar-'+i).value;
  const body={instances:[{prompt:pr}],parameters:{aspectRatio:ar,sampleCount:1}};
  const resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+md.id+':predict?key='+k,{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
  });
  if(!resp.ok){const et=await resp.text();throw new Error('API '+resp.status+': '+et.substring(0,100));}
  const d=await resp.json();
  if(!d.predictions||!d.predictions[0])throw new Error('No predictions returned');
  const b64=d.predictions[0].bytesBase64Encoded;
  if(!b64)throw new Error('No image data in response');
  const bl=new Blob([Uint8Array.from(atob(b64),c=>c.charCodeAt(0))],{type:'image/png'});
  const u=URL.createObjectURL(bl);
  nS[i].ru=u;nS[i].rb=bl;
  setStatus('nst-'+i,'success','Done!');
  document.getElementById('nres-'+i).innerHTML='<img src="'+u+'" class="output-img" onclick="window.open(this.src)"><a href="'+u+'" download="nano_'+(i+1)+'.png" class="btn btn-success btn-small">‚¨á</a>';
}

async function nGenVeo(i,k,pr,md){
  setStatus('nst-'+i,'generating','Submitting...');
  const ar=document.getElementById('nar-'+i).value;
  const dur=document.getElementById('ndur-'+i).value;
  const reso=document.getElementById('nreso-'+i).value;
  const instance={prompt:pr};
  if(nS[i].imgs[0]){const b=await toB64(nS[i].imgs[0]);instance.image={inlineData:{mimeType:nS[i].imgs[0].type,data:b}};}
  if(nS[i].imgs[1]){const b=await toB64(nS[i].imgs[1]);instance.lastFrame={inlineData:{mimeType:nS[i].imgs[1].type,data:b}};}
  const body={instances:[instance],parameters:{aspectRatio:ar,resolution:reso,durationSeconds:parseInt(dur)}};
  const resp=await fetch('https://generativelanguage.googleapis.com/v1beta/models/'+md.id+':predictLongRunning?key='+k,{
    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
  });
  if(!resp.ok){const et=await resp.text();throw new Error('API '+resp.status+': '+et.substring(0,100));}
  const op=await resp.json();
  if(!op.name)throw new Error('No operation name returned');
  // Poll
  while(true){
    await new Promise(r=>setTimeout(r,10000));
    setStatus('nst-'+i,'generating','Polling...');
    const pr2=await fetch('https://generativelanguage.googleapis.com/v1beta/'+op.name+'?key='+k);
    if(!pr2.ok){const et=await pr2.text();throw new Error('Poll '+pr2.status+': '+et.substring(0,100));}
    const st=await pr2.json();
    if(st.done){
      if(st.error)throw new Error(st.error.message||'Operation failed');
      const samples=st.response?.generateVideoResponse?.generatedSamples;
      if(!samples||!samples[0]?.video?.uri)throw new Error('No video in response');
      const vidUri=samples[0].video.uri;
      // Fetch video with API key header
      setStatus('nst-'+i,'generating','Downloading video...');
      const vResp=await fetch(vidUri,{headers:{'x-goog-api-key':k}});
      if(!vResp.ok)throw new Error('Video fetch '+vResp.status);
      const vBlob=await vResp.blob();
      const vUrl=URL.createObjectURL(vBlob);
      nS[i].ru=vUrl;nS[i].rb=vBlob;
      setStatus('nst-'+i,'success','Done!');
      document.getElementById('nres-'+i).innerHTML='<video src="'+vUrl+'" controls class="output-video"></video><a href="'+vUrl+'" download="nano_'+(i+1)+'.mp4" class="btn btn-success btn-small">‚¨á</a>';
      return;
    }
  }
}

async function nGen(i){
  const k=document.getElementById('n-apiKey').value.trim(),pr=document.getElementById('np-'+i).value.trim();
  if(!k)return setStatus('nst-'+i,'error','Enter API key');
  if(!pr)return setStatus('nst-'+i,'error','Enter prompt');
  const md=nModelDef(document.getElementById('nm-'+i).value);
  try{
    if(md.type==='gemini')await nGenGemini(i,k,pr,md);
    else if(md.type==='imagen')await nGenImagen(i,k,pr,md);
    else if(md.type==='veo')await nGenVeo(i,k,pr,md);
  }catch(e){setStatus('nst-'+i,'error',e.message.substring(0,60));}
}
function nanoGenerateAll(){const p=[];for(let i=0;i<NN;i++)if(document.getElementById('np-'+i).value.trim()&&!nS[i].ru)p.push(nGen(i));if(!p.length)alert('Enter prompt in at least one row');Promise.allSettled(p);}
function nanoDownloadAll(){nS.forEach((s,i)=>{if(s.ru){const a=document.createElement('a');a.href=s.ru;a.download='nano_'+(i+1)+(s.rb&&s.rb.type&&s.rb.type.includes('video')?'.mp4':'.png');a.click();}});}

// FLUX
const NF=10,fS=Array.from({length:NF},()=>({ru:null}));
function initF(){const c=document.getElementById('flux-rows');c.innerHTML='';for(let i=0;i<NF;i++){c.innerHTML+='<div class="row img-row" id="fr-'+i+'"><div class="row-num">'+(i+1)+'</div><div class="frame-box"><label>Preview</label><div class="drop-zone" id="fp-'+i+'" style="cursor:default;border-style:solid"><span>Result</span></div></div><div class="prompt-settings"><textarea id="fpr-'+i+'" placeholder="Include trigger word in prompt..."></textarea></div><div class="actions"><button class="btn btn-primary btn-small" onclick="fGen('+i+')">Generate</button><div class="status" id="fst-'+i+'"></div><div class="result-area" id="fres-'+i+'"></div></div></div>';}}
async function fGen(i){const k=document.getElementById('f-apiKey').value.trim(),lu=document.getElementById('f-loraUrl').value.trim(),tr=document.getElementById('f-trigger').value.trim(),pr=document.getElementById('fpr-'+i).value.trim();if(!k)return setStatus('fst-'+i,'error','Enter fal key');if(!lu)return setStatus('fst-'+i,'error','Enter LoRA URL');if(!pr)return setStatus('fst-'+i,'error','Enter prompt');if(tr&&!pr.includes(tr))return setStatus('fst-'+i,'error','Include "'+tr+'" in prompt');try{setStatus('fst-'+i,'generating','Submitting...');const sc=parseFloat(document.getElementById('f-scale').value)||0.9;const r=await falPoll('fal-ai/flux-lora',{prompt:pr,loras:[{path:lu,scale:sc}],image_size:document.getElementById('f-size').value,num_images:1},k,'fst-'+i);const u=r.images[0].url;fS[i].ru=u;setStatus('fst-'+i,'success','Done!');document.getElementById('fp-'+i).style.backgroundImage='url('+u+')';document.getElementById('fp-'+i).classList.add('has-image');document.getElementById('fres-'+i).innerHTML='<a href="'+u+'" target="_blank" class="btn btn-outline btn-small">üîç</a><a href="'+u+'" download="flux_'+(i+1)+'.jpg" class="btn btn-success btn-small">‚¨á</a>';}catch(e){setStatus('fst-'+i,'error',e.message.substring(0,60));}}
function fluxGenerateAll(){const p=[];for(let i=0;i<NF;i++)if(document.getElementById('fpr-'+i).value.trim()&&!fS[i].ru)p.push(fGen(i));if(!p.length)alert('Enter prompt in at least one row');Promise.allSettled(p);}
function fluxDownloadAll(){fS.forEach((s,i)=>{if(s.ru){const a=document.createElement('a');a.href=s.ru;a.download='flux_'+(i+1)+'.jpg';a.click();}});}

// INIT
initV();initN();initF();
['v-apiKey','n-apiKey','f-apiKey','f-loraUrl','f-trigger'].forEach(id=>{const el=document.getElementById(id);const s=localStorage.getItem('ai-'+id);if(s)el.value=s;el.addEventListener('change',()=>localStorage.setItem('ai-'+id,el.value));});
</script>
</body>
</html>
